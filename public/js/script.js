var response=[{day:"Sunday",purchases:[{purchaseName:"Batteries",storeName:"Wellmart",description:"Duracell",price:"9.99"}]},{day:"Monday",purchases:[{purchaseName:"Batteries",storeName:"Wellmart",description:"Duracell",price:"9.99"},{purchaseName:"Ice-cream",storeName:"Wellmart",description:"",price:"19.99"}]},{day:"Tuesday",purchases:[{purchaseName:"Gift-cards",storeName:"Tesco",description:"Class",price:"199.99"},{purchaseName:"Shampoo",storeName:"Tangelman",description:"Shampoo",price:"99.99"}]},{day:"Wednesday",purchases:[{purchaseName:"TV-set",storeName:"Comfy",description:"",price:"19999.99"}]},{day:"Thursday",purchases:[{purchaseName:"Batteries",storeName:"Wellmart",description:"Duracell",price:"9.99"}]},{day:"Friday",purchases:[{purchaseName:"Batteries",storeName:"Wellmart",description:"Duracell",price:"9.99"}]},{day:"Saturday",purchases:[{purchaseName:"Batteries",storeName:"Wellmart",description:"Duracell",price:"9.99"}]}],App={Models:{},Collections:{},Views:{}};$(function(){new App.Views.PurchaseManagerView({collection:response,el:$("#purchase-manager")})}),App.Models.DayModel=Backbone.Model.extend({defaults:{day:"Monday",purchases:[]}}),App.Models.PurchaseModel=Backbone.Model.extend({validation:{purchaseName:{required:!0},storeName:{required:!0},description:{required:!0},price:{range:[5,1e9]}}}),App.Collections.DaysCollection=Backbone.Collection.extend({model:App.Models.DayModel}),App.Collections.PurchasesCollection=Backbone.Collection.extend({model:App.Models.PurchaseModel}),App.Views.DayInfoView=Backbone.View.extend({tagName:"label",template:_.template(templates.get("day-label-template")()),initialize:function(){this._modelBinder=new Backbone.ModelBinder,this.render()},render:function(){return this.$el.html(this.template(this.model.toJSON())),this._modelBinder.bind(this.model,this.el),this}}),App.Views.DaysCollectionView=Backbone.View.extend({tagName:"ul",className:"list",initialize:function(){var e=function(e){return new App.Views.DayView({model:e})},i=new Backbone.CollectionBinder.ViewManagerFactory(e);this._modelBinder=new Backbone.ModelBinder,this._collectionBinder=new Backbone.CollectionBinder(i),this.render()},render:function(){return this._collectionBinder.bind(this.collection,this.$el),this}}),App.Views.DayView=Backbone.View.extend({tagName:"li",template:_.template(templates.get("day-template")()),events:{click:"renderDayPurchases"},initialize:function(){this._modelBinder=new Backbone.ModelBinder},render:function(){return this.$el.html(this.template()),this._modelBinder.bind(this.model,this.el,Backbone.ModelBinder.createDefaultBindings(this.el,"data-name")),this},renderDayPurchases:function(){Backbone.Mediator.pub("ChangeDayPurchases",this.model)}}),App.Views.PopupView=Backbone.View.extend({className:"popup",template:_.template(templates.get("popup-template")()),events:{"click .popup-close":"cancel","click #add-popup":"addPurchase","click #cancel-popup":"cancel","click #save-popup":"savePurchase","click #remove":"removePurchase"},initialize:function(){this.initialModel=this.model,this._modelBinder=new Backbone.ModelBinder},render:function(){return this.model?this.renderPopupEdit():(this.model=new App.Models.PurchaseModel,this.renderPopupCreate()),this.setValidation(),this._modelBinder.bind(this.model,this.el),this},setValidation:function(){Backbone.Validation.bind(this,{model:this.model}),Backbone.Validation.bind(this,{valid:function(e,i){e.$el.find("[data-name="+i+"].warning").hide()},invalid:function(e,i,t){e.$el.find("[data-name="+i+"].warning").show()}})},renderPopupCreate:function(){return this.$el.html(this.template,this),this.$el.find("#add-popup").show(),this.$el.find("#save-popup").hide(),this.$el.find("#remove").hide(),this},renderPopupEdit:function(){return this.$el.html(this.template(this.model.toJSON())),this.$el.find("h1").val("Edit purchase"),this.$el.find("#add-popup").hide(),this.$el.find("#save-popup").show(),this.$el.find("#remove").show(),this},cancel:function(){this.model=this.initialModel,this.$el.remove()},addPurchase:function(){this.model.validate(),this.model.isValid()&&(this.$el.remove(),Backbone.Mediator.pub("addNewPurchase",this.model))},savePurchase:function(){this.model.validate(),this.model.isValid()&&(this.$el.remove(),Backbone.Mediator.pub("editPurchase",this.model))},removePurchase:function(){this.remove(),Backbone.Mediator.pub("deletePurchase",this.model)},close:function(){this._modelBinder.unbind()}}),App.Views.PurchaseManagerView=Backbone.View.extend({template:_.template(templates.get("purchase-manager-template")()),events:{"click #popup":"createNewPurchase"},initialize:function(){this.date=new Date,Backbone.Mediator.sub("ChangeDayPurchases",this.renderDay,this),this.render()},render:function(){this.$el.html(this.template()),this.renderDays(),this.renderDay()},renderDay:function(e){var e=e||new App.Models.DayModel({day:this.collection[this.date.getDay()].day});new App.Views.DayInfoView({model:e,el:this.$el.find("#day-label")});this.renderPurchases(e)},renderDays:function(){var e=new App.Collections.DaysCollection(this.collection);new App.Views.DaysCollectionView({collection:e,el:this.$el.find("#list")})},renderPurchases:function(e){var i=_.findWhere(this.collection,{day:e.get("day")}).purchases||this.collection[this.date.getDay()].purchases,t=new App.Collections.PurchasesCollection(i);new App.Views.PurchasesCollectionView({collection:t,el:this.$el.find(".purchase-list")})},createNewPurchase:function(){var e=new App.Views.PopupView({collection:this.collection[0].purchases});$("body").append(e.render().el)}}),App.Views.PurchasesCollectionView=Backbone.View.extend({tagName:"tbody",className:"purchase-list",initialize:function(){Backbone.Mediator.sub("addNewPurchase",this.addPurchase,this),Backbone.Mediator.sub("deletePurchase",this.deletePurchase,this),this.render()},render:function(){var e=function(e){return new App.Views.PurchaseView({model:e})},i=new Backbone.CollectionBinder.ViewManagerFactory(e);return this.$el.html(""),this._collectionBinder=new Backbone.CollectionBinder(i),this._collectionBinder.bind(this.collection,this.$el),this},addPurchase:function(e){this.collection.add(e),this.render(this.collection)},deletePurchase:function(e){this.collection.remove(e)},close:function(){}}),App.Views.PurchaseView=Backbone.View.extend({tagName:"tr",template:_.template(templates.get("purchase-raw-template")()),events:{click:"editPurchase","click .delete":"deletePurchase"},initialize:function(){this._modelBinder=new Backbone.ModelBinder,this.render()},render:function(){return this.$el.html(this.template(this.model.toJSON())),this._modelBinder.bind(this.model,this.el),this},editPurchase:function(){var e=new App.Views.PopupView({model:this.model});$("body").append(e.render().el)},deletePurchase:function(e){e.stopPropagation(),Backbone.Mediator.pub("deletePurchase",this.model)}});